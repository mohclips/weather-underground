#!/usr/local/bin/python3

##  rtl_433 -F "mqtt://mqtt_bus:1883,retain=60,events=rtl_433/[model],devices=rtl_433/[model]/[id]"


import paho.mqtt.client as mqtt

import pymysqlpool
#import pymysql.cursors

import sys
import time

import requests
import json
import math
import re

import login_details

DEBUG=1

sensor_model="Fineoffset-WHx080"

software_name = "Custom_RTL433"

#############################################################################################

# approximation valid for
# 0 degC < T < 60 degC
# 1% < RH < 100%
# 0 degC < Td < 50 degC 
# constants
a = 17.271
b = 237.7 # degC
# https://www.meteo-blog.net/2012-05/dewpoint-calculation-script-in-python/
def dewpoint_approximation(T,RH):
    Td = (b * gamma(T,RH)) / (a - gamma(T,RH))
    return Td
def gamma(T,RH):
    g = (a * T / (b + T)) + math.log(RH/100.0)
    return g


def hpa_to_inches(pressure_in_hpa):
    pressure_in_inches_of_m = pressure_in_hpa * 0.02953
    return pressure_in_inches_of_m

#############################################################################################



def get_latest_air():

    sql="SELECT cdate,SDS_P1, SDS_P2,temperature,humidity FROM weather.air_sensor \
            where cdate > DATE_SUB(NOW(), INTERVAL '6' MINUTE) \
            order by id desc limit 1;"



def save_to_weewx_archive(j,T,RH,Td):
    """

    Table: archive

Columns:
	dateTime	int(11) PK
	usUnits	int(11)
	interval	int(11)
	barometer	double
	pressure	double
	altimeter	double
	inTemp	double
	outTemp	double
	inHumidity	double
	outHumidity	double
	windSpeed	double
	windDir	double
	windGust	double
	windGustDir	double
	rainRate	double
	rain	double
	dewpoint	double
	windchill	double
	heatindex	double
	ET	double
	radiation	double
	UV	double
	extraTemp1	double
	extraTemp2	double
	extraTemp3	double
	soilTemp1	double
	soilTemp2	double
	soilTemp3	double
	soilTemp4	double
	leafTemp1	double
	leafTemp2	double
	extraHumid1	double
	extraHumid2	double
	soilMoist1	double
	soilMoist2	double
	soilMoist3	double
	soilMoist4	double
	leafWet1	double
	leafWet2	double
	rxCheckPercent	double
	txBatteryStatus	double
	consBatteryVoltage	double
	hail	double
	hailRate	double
	heatingTemp	double
	heatingVoltage	double
	supplyVoltage	double
	referenceVoltage	double
	windBatteryStatus	double
	rainBatteryStatus	double
	outTempBatteryStatus	double
	inTempBatteryStatus	double
"""

    sql="""INSERT INTO `weewx`.`archive`
    (`dateTime`,
    `usUnits`,
    `interval`,
    `barometer`,
    `pressure`,
    `altimeter`,
    `inTemp`,
    `outTemp`,
    `inHumidity`,
    `outHumidity`,
    `windSpeed`,
    `windDir`,
    `windGust`,
    `rainRate`,
    `rain`,
    `dewpoint`,
    `outTempBatteryStatus`,
    )
    VALUES (
    "%s", -- `dateTime`
    "%d", -- `usUnits`
    "%d", -- `interval`
    "%f", -- `barometer`
    "%f", -- `pressure`
    "%f", -- `inTemp`
    "%f", -- `outTemp`
    "%f", -- `inHumidity`
    "%f", -- `outHumidity`
    "%f", -- `windSpeed`
    "%f", -- `windDir`
    "%f", -- `windGust`
    "%f", -- `rain`
    "%f", -- `dewpoint`
    "%d", -- `outTempBatteryStatus`
    )
"""
    config={'host':'xxxx', 'user':'xxx', 'password':'xxx', 'database':'xxx', 'autocommit':True}

    pymysqlpool.logger.setLevel('DEBUG')

    pool1 = pymysqlpool.ConnectionPool(size=2, name='pool1', **config)

    con1 = pool1.get_connection()
    
    pool1.size()

    try:
        db = pymysql.connect(host=login_details.mysqlHost, user=login_details.mysqlUser, 
            password=login_details.mysqlPassword, db=login_details.dbName, 
            charset='utf8mb4', cursorclass=pymysql.cursors.DictCursor)
        #print("MySQL Client Connected")
    except pymysql.Error as e:
        print("MySQL Connect Error:",e)
        #sys.exit()
        #db.close()  # cant db.close here as its not open anyway
        return
    
    with db.cursor() as cursor:
        try:
            #sql = "INSERT INTO `indoor_temperature` (`sensor_id`, `date_time`, `value`, `vtype`) VALUES (%s, %s, %s, %s)"
            cursor.execute(sql, (j['time'], 1, 1, 0, 0, 0, 
                (T * 9.0 / 5.0) + 32.0,
                0,
                j['humidity'],
                (j['wind_max_km_h'] * 0.62137119),
                j['wind_dir_deg'],
                (j['wind_avg_km_h'] * 0.62137119),
                (j['rain_mm'] * 0.0393701),
                ((Td * 9.0 / 5.0) + 32.0),
                int(j['battery_ok'])
            ))
        except pymysql.Error as e:
            print("MySQL Insert Error:",e)
            #sys.exit()
            db.close()
            return
        finally:
            db.commit()
    db.close()
    print("DB success")


#############################################################################################

def on_connect(client, userdata, flags, rc):
    print("MQTT Client Connected")

    # have to use events topic to get the raw json
    client.subscribe("rtl_433/events/"+sensor_model)

def on_message(client, userdata, msg):
    #print("Transmission received")

    value = str(msg.payload.decode("utf-8")).strip() # payload is the value, in this case the json

    # TODO: pull air quality stats from mySQL
    #cdate,SDS_P1, SDS_P2,temperature,humidity = get_latest_air()


    if DEBUG==1:
        print("Rcv:",value)

    j = json.loads(value)

    T=float(j['temperature_C'])
    RH=float(j['humidity'])
    Td = dewpoint_approximation(T,RH)

    # TODO: save all data back to old weewx DB
    ##save_to_weewx_archive(j,T,RH,Td)

    # build URL
    # https://kapuablog.wordpress.com/2021/02/07/pws-weather-underground-upload/

    url = "https://weatherstation.wunderground.com/weatherstation/updateweatherstation.php"
    url += "?action=updateraw"
    url += "&ID=" + login_details.wu_id
    url += "&PASSWORD="  + login_details.wu_password
    url += "&softwaretype=" + software_name
    url += "&dateutc=" + j['time']
    url += "&dailyrainin=" + "{0:.2f}".format(j['rain_mm'] * 0.0393701)
    url += "&dewptf=" + "{0:.2f}".format((Td * 9.0 / 5.0) + 32.0)
    #url += "&rainin=" + j['rain_mm']
    url += "&humidity=" + str(j['humidity'])
    url += "&tempf=" + "{0:.2f}".format((T * 9.0 / 5.0) + 32.0)
    url += "&winddir=" + str(j['wind_dir_deg'])
    url += "&windgustmph=" + "{0:.2f}".format(j['wind_max_km_h'] * 0.62137119)
    url += "&windspeedmph=" + "{0:.2f}".format(j['wind_avg_km_h'] * 0.62137119)

    # PressureHpa * 0.0295299830714,
    # RainToday * 0.0393701,
    # RainLastHour * 0.0393701

    print(re.sub("PASSWORD=.*?\&","PASSWORD=XXXXXXX&",url))

    # send to WU
    r= requests.get(url)
    if DEBUG==1:
        print("Received " + str(r.status_code) + " " + str(r.text))

    

#############################################################################################

# Connect the MQTT Client
client = mqtt.Client("weatherunderground-1")
client.on_connect = on_connect
client.on_message = on_message
# client.username_pw_set(username=mqttUser, password=mqttPassword)
try:
    client.connect(login_details.mqttBroker, login_details.mqttBrokerPort, 60)
except:
    sys.exit("Connection to MQTT Broker failed")

# Stay connected to the MQTT Broker indefinitely
client.loop_forever()

# client.loop_start() #start the loop
# time.sleep(10) # wait
# client.loop_stop()
